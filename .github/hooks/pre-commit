#!/bin/bash
# Pre-commit hook for NovaChat
# Runs real configured checks for changed areas.

set -euo pipefail

echo "Running pre-commit checks..."

if ! command -v git >/dev/null 2>&1; then
  echo "git is required"
  exit 1
fi

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
  echo "No staged files detected"
  exit 0
fi

# Android-related changes
if echo "$STAGED_FILES" | grep -E '^(app/|feature-ai/|core-common/|core-network/|build.gradle.kts|settings.gradle.kts|gradle/|gradle.properties|gradle/libs.versions.toml)' >/dev/null; then
  if [ ! -f "gradlew" ]; then
    echo "gradlew not found"
    exit 1
  fi

  chmod +x gradlew
  echo "Running :feature-ai:testDebugUnitTest"
  ./gradlew :feature-ai:testDebugUnitTest --no-daemon
fi

# Functions changes
if echo "$STAGED_FILES" | grep -E '^functions/' >/dev/null; then
  if [ ! -d "functions" ]; then
    echo "functions directory not found"
    exit 1
  fi

  echo "Running functions build + lint"
  (cd functions && npm run build && npm run lint)
fi

# JS/TS/JSON formatting checks
if echo "$STAGED_FILES" | grep -E '\.(js|ts|json)$' >/dev/null; then
  if [ -f "package.json" ]; then
    echo "Running format:check"
    npm run format:check
  fi
fi

echo "Pre-commit checks passed"
