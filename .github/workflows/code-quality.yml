name: Code Quality

on:
  push:
    branches:
      - main
    paths:
      - 'app/**/*.kt'
      - '.github/workflows/code-quality.yml'
  pull_request:
    branches:
      - main
      - 'copilot/**'
    paths:
      - 'app/**/*.kt'
      - '.github/workflows/code-quality.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  commitlint:
    name: Commit Message Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Lint commit messages
        uses: wagoid/commitlint-github-action@v6
        with:
          configFile: .commitlintrc.json

  ktlint:
    name: Kotlin Linting (ktlint)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check app directory exists
        id: check_app
        run: |
          if [ -d "app" ] && [ -f "gradlew" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up JDK 21
        if: steps.check_app.outputs.exists == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        if: steps.check_app.outputs.exists == 'true'
        run: |
          if [ -f "gradlew" ]; then
            chmod +x gradlew
          else
            echo "gradlew not found, skipping"
          fi
      
      - name: Run ktlint
        if: steps.check_app.outputs.exists == 'true'
        run: |
          ./gradlew ktlintCheck --no-daemon || echo "ktlint not configured"
        continue-on-error: true
      
      - name: Upload ktlint reports
        if: steps.check_app.outputs.exists == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: ktlint-reports
          path: |
            app/build/reports/ktlint/
          retention-days: 7
        continue-on-error: true

  detekt:
    name: Static Code Analysis (Detekt)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check app directory exists
        id: check_app
        run: |
          if [ -d "app" ] && [ -f "gradlew" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up JDK 21
        if: steps.check_app.outputs.exists == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        if: steps.check_app.outputs.exists == 'true'
        run: |
          if [ -f "gradlew" ]; then
            chmod +x gradlew
          else
            echo "gradlew not found, skipping"
          fi
      
      - name: Run Detekt
        if: steps.check_app.outputs.exists == 'true'
        run: |
          ./gradlew detekt --no-daemon || echo "detekt not configured"
        continue-on-error: true
      
      - name: Upload detekt reports
        if: steps.check_app.outputs.exists == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: detekt-reports
          path: |
            app/build/reports/detekt/
          retention-days: 7
        continue-on-error: true

  android-lint:
    name: Android Lint Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check app directory exists
        id: check_app
        run: |
          if [ -d "app" ] && [ -f "gradlew" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up JDK 21
        if: steps.check_app.outputs.exists == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        if: steps.check_app.outputs.exists == 'true'
        run: |
          if [ -f "gradlew" ]; then
            chmod +x gradlew
          else
            echo "gradlew not found, skipping"
          fi
      
      - name: Run Android Lint
        if: steps.check_app.outputs.exists == 'true'
        run: ./gradlew lintDebug --no-daemon
        continue-on-error: true
      
      - name: Upload lint reports
        if: steps.check_app.outputs.exists == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: android-lint-reports
          path: |
            app/build/reports/lint-results-*.html
            app/build/reports/lint-results-*.xml
          retention-days: 7
      
      - name: Annotate lint issues
        if: steps.check_app.outputs.exists == 'true' && github.event_name == 'pull_request'
        uses: yutailang0119/action-android-lint@v3
        with:
          report-path: app/build/reports/lint-results-*.xml
        continue-on-error: true

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check app directory exists
        id: check_app
        run: |
          if [ -d "app" ] && [ -f "gradlew" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up JDK 21
        if: steps.check_app.outputs.exists == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        if: steps.check_app.outputs.exists == 'true'
        run: |
          if [ -f "gradlew" ]; then
            chmod +x gradlew
          else
            echo "gradlew not found, skipping"
          fi
      
      - name: Run tests with coverage
        if: steps.check_app.outputs.exists == 'true'
        run: |
          ./gradlew testDebugUnitTestCoverage --no-daemon || ./gradlew testDebugUnitTest --no-daemon
        continue-on-error: true
      
      - name: Upload coverage reports
        if: steps.check_app.outputs.exists == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            app/build/reports/coverage/
            app/build/reports/jacoco/
          retention-days: 7
        continue-on-error: true
