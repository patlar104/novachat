#!/bin/bash
# Pre-commit hook for NovaChat
# Runs ktlint format and basic validation before commit

set -e

echo "üîç Running pre-commit checks..."

# Check if app directory exists
if [ ! -d "app" ]; then
    echo "‚úÖ No app directory found, skipping checks"
    exit 0
fi

# Check if gradlew exists
if [ ! -f "gradlew" ]; then
    echo "‚ö†Ô∏è  gradlew not found, skipping checks"
    exit 0
fi

# Make gradlew executable
chmod +x gradlew

# Get list of staged Kotlin files
STAGED_KT_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.kt$' || true)

if [ -z "$STAGED_KT_FILES" ]; then
    echo "‚úÖ No Kotlin files changed"
    exit 0
fi

echo "üìù Found Kotlin files to check:"
echo "$STAGED_KT_FILES"

# Run ktlint format on staged files (if ktlint is configured)
echo ""
echo "üé® Running ktlint format..."
if ./gradlew ktlintFormat --quiet 2>/dev/null; then
    echo "‚úÖ ktlint format completed"
    
    # Re-add formatted files
    for file in $STAGED_KT_FILES; do
        if [ -f "$file" ]; then
            git add "$file"
        fi
    done
else
    echo "‚ö†Ô∏è  ktlint not configured or failed, continuing..."
fi

# Run basic Kotlin compilation check (optional, commented out for speed)
# echo ""
# echo "üî® Running compilation check..."
# if ./gradlew compileDebugKotlin --quiet; then
#     echo "‚úÖ Compilation check passed"
# else
#     echo "‚ùå Compilation check failed"
#     exit 1
# fi

echo ""
echo "‚úÖ Pre-commit checks completed successfully!"
exit 0
